name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: 10.0.x

    - name: .NET info
      shell: bash
      run: |
        set -euo pipefail
        echo "PATH=$PATH"
        which dotnet || true
        dotnet --info
        dotnet --list-sdks

    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build
      run: dotnet build --no-restore --configuration Release /p:ContinuousIntegrationBuild=true

  test:
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 30

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: 10.0.x

    - name: .NET info
      shell: bash
      run: |
        set -euo pipefail
        echo "PATH=$PATH"
        which dotnet || true
        dotnet --info
        dotnet --list-sdks

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --no-restore --configuration Release /p:ContinuousIntegrationBuild=true

    - name: Check disk space before test
      shell: bash
      run: |
        echo "=== Disk space (df -h) ==="
        df -h

        echo "=== Disk usage in workspace ==="
        du -sh . || true

        echo "=== Largest directories (top 20) ==="
        du -Sh . | sort -rh | head -n 20 || true

        echo "=== Disk usage in /home/runner ==="
        du -sh /home/runner || true

        echo "=== Disk usage in /tmp ==="
        du -sh /tmp || true

    - name: Test (normal)
      id: test_normal
      continue-on-error: true
      shell: bash
      env:
        DOTNET_CLI_TELEMETRY_OPTOUT: '1'
        DOTNET_NOLOGO: '1'
      run: |
        set -euo pipefail
        mkdir -p TestResults
        dotnet test ./tests/JohBloch.ConfluentKafka.SchemaRegistryExtClient.Tests/JohBloch.ConfluentKafka.SchemaRegistryExtClient.Tests.csproj \
          --configuration Release \
          --verbosity normal \
          --results-directory TestResults \
          --logger "trx;LogFileName=test-results.trx" \
          --diag "TestResults/vstest.normal.diag.log" \
          --blame-crash \
          --blame-crash-dump-type full \
          --blame-hang \
          --blame-hang-timeout 5m \
          --filter "FullyQualifiedName!=JohBloch.ConfluentKafka.SchemaRegistryExtClient.Tests.DIRegistrationTests.TokenManager_Is_Registered_When_TokenFunc_Provided"

    - name: Test (diagnostics on failure)
      if: steps.test_normal.outcome == 'failure'
      continue-on-error: true
      shell: bash
      env:
        DOTNET_CLI_TELEMETRY_OPTOUT: '1'
        DOTNET_NOLOGO: '1'
      run: |
        set -euo pipefail
        mkdir -p TestResults
        dotnet test ./tests/JohBloch.ConfluentKafka.SchemaRegistryExtClient.Tests/JohBloch.ConfluentKafka.SchemaRegistryExtClient.Tests.csproj \
          --configuration Release \
          --verbosity diagnostic \
          --results-directory TestResults \
          --logger "trx;LogFileName=test-results.diag.trx" \
          --diag "TestResults/vstest.diag.log" \
          --blame-crash \
          --blame-crash-dump-type full \
          --blame-hang \
          --blame-hang-timeout 5m \
          --filter "FullyQualifiedName!=JohBloch.ConfluentKafka.SchemaRegistryExtClient.Tests.DIRegistrationTests.TokenManager_Is_Registered_When_TokenFunc_Provided"

    - name: Debug test artifacts
      run: |
        echo "PWD: $(pwd)"
        echo "List TestResults folder:"
        ls -la TestResults || true
        echo "Find any .trx files:"
        find . -type f -name "*.trx" -print || true
        echo "Find any vstest diagnostic logs:"
        find . -type f -name "vstest*.log" -print || true

    - name: Gather test artifacts into canonical TestResults
      shell: bash
      run: |
        set -euo pipefail
        mkdir -p TestResults
        echo "Searching for test artifacts in workspace..."
        mapfile -t files < <(find . -type f \( -name "*.trx" -o -name "vstest*.log" -o -name "Sequence.xml" -o -name "*.dmp" -o -name "*.hangdump" -o -name "*.crashdump" \) -print || true)
        if [ ${#files[@]} -eq 0 ]; then
          echo "No test artifacts found"
        else
          echo "Copying ${#files[@]} file(s) to ./TestResults/collected (preserving paths)"
          mkdir -p TestResults/collected
          for f in "${files[@]}"; do
            echo " - $f"
            cp --parents "$f" TestResults/collected/ || true
          done
          echo "Destination contents:" ; ls -la TestResults || true
        fi

    - name: Inspect crash dump (strings)
      if: steps.test_normal.outcome == 'failure'
      continue-on-error: true
      shell: bash
      run: |
        set -euo pipefail

        echo "=== TestResults contents (top 200) ==="
        find ./TestResults -maxdepth 4 -type f | sort | head -n 200 || true

        echo "=== Crash dumps found ==="
        dumps=$(ls -1 ./TestResults/**/dotnet_*_crashdump.dmp 2>/dev/null || true)
        if [ -z "${dumps}" ]; then
          echo "No crash dumps found under ./TestResults"
          exit 0
        fi
        echo "${dumps}"

        for dump in ${dumps}; do
          echo "=== strings grep on ${dump} (first 200 matches) ==="
          # This is intentionally lightweight and robust (no external debuggers).
          strings -a "${dump}" \
            | grep -i -E "librdkafka|rdkafka|confluent\.kafka|confluent|kafka" \
            | head -n 200 \
            || true
        done

    - name: Check disk space after test
      if: success() || failure()
      shell: bash
      run: |
        echo "=== Disk space AFTER test (df -h) ==="
        df -h

        echo "=== Disk usage in workspace after test ==="
        du -sh . || true

        echo "=== Largest directories (top 20) ==="
        du -Sh . | sort -rh | head -n 20 || true

    - name: Test Report
      uses: dorny/test-reporter@v2
      if: ${{ !cancelled() }}
      with:
        name: Test Results
        path: '**/*.trx'
        reporter: dotnet-trx
        fail-on-empty: 'false'

    - name: Upload TestResults (including blame)
      if: success() || failure()
      uses: actions/upload-artifact@v4
      with:
        name: testresults
        path: TestResults/

    - name: Fail if tests failed
      if: steps.test_normal.outcome == 'failure'
      shell: bash
      run: |
        echo "Tests failed (see TestResults artifacts)."
        exit 1
